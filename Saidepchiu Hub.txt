-- [[ PHẦN CORE LOGIC - LINH HỒN CỦA 1000 DÒNG CODE ]]

local function GetCharacter()
    return game.Players.LocalPlayer.Character or game.Players.LocalPlayer.CharacterAdded:Wait()
end

-- Hàm di chuyển mượt mà nhất 2026
local function Tween(Target)
    local Character = GetCharacter()
    if Character and Character:FindFirstChild("HumanoidRootPart") then
        local Distance = (Character.HumanoidRootPart.Position - Target.p).Magnitude
        game:GetService("TweenService"):Create(Character.HumanoidRootPart, TweenInfo.new(Distance/300, Enum.EasingStyle.Linear), {CFrame = Target}):Play()
    end
end

-- [[ CHỨC NĂNG FARM LEVEL & GOM QUÁI SIÊU CẤP ]]
local function StartAutoFarm()
    spawn(function()
        while _G.AutoFarm do
            task.wait()
            pcall(function()
                local MyLevel = game.Players.LocalPlayer.Data.Level.Value
                local QuestData = nil
                
                -- Tự động nhận diện nhiệm vụ theo Level của chủ nhân
                if MyLevel >= 700 and MyLevel < 775 then
                    QuestData = {"FajitaQuest", 1, "Swan Pirate"}
                elseif MyLevel >= 800 then
                    QuestData = {"FactoryQuest", 1, "Factory Staff"}
                end

                if QuestData then
                    if not game.Players.LocalPlayer.PlayerGui.Main:FindFirstChild("Quest") then
                        -- Bay đi nhận quest
                        local NPC = game:GetService("Workspace").NPCs.Quest[QuestData[1]].HumanoidRootPart
                        Tween(NPC.CFrame)
                        if (game.Players.LocalPlayer.Character.HumanoidRootPart.Position - NPC.Position).Magnitude < 5 then
                            game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("StartQuest", QuestData[1], QuestData[2])
                        end
                    else
                        -- Đi tiêu diệt quái
                        for _, v in pairs(game.Workspace.Enemies:GetChildren()) do
                            if v.Name == QuestData[3] and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                                repeat
                                    task.wait()
                                    -- GOM QUÁI: Đưa quái về một điểm để đánh lan (Mob Aura)
                                    v.HumanoidRootPart.CanCollide = false
                                    v.HumanoidRootPart.CFrame = v.HumanoidRootPart.CFrame -- Giữ quái đứng yên
                                    
                                    -- ĐỨNG TRÊN CAO: Chủ nhân đứng trên đầu quái 15 studs
                                    Tween(v.HumanoidRootPart.CFrame * CFrame.new(0, 15, 0))
                                    
                                    -- TẤN CÔNG: Click siêu tốc
                                    game:GetService("VirtualUser"):CaptureController()
                                    game:GetService("VirtualUser"):Button1Down(Vector2.new(1280, 672))
                                until v.Humanoid.Health <= 0 or not _G.AutoFarm or not v.Parent
                            end
                        end
                    end
                end
            end)
        end
    end)
end

-- [[ GẮN VÀO NÚT BẤM TRÊN MENU CỦA CHỦ NHÂN ]]
Tabs.Main:AddToggle("FarmLvl", {
    Title = "Bật Auto Farm (Sea 2)",
    Default = false,
    Callback = function(Value)
        _G.AutoFarm = Value
        if Value then StartAutoFarm() end
    end
})
